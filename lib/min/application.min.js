var CategoryMenu;

(function($, _){
    CategoryMenu = function(el) {
        this.el = el;
        this.$el = $(el);
        this.init();
    };

    _.extend(CategoryMenu.prototype, {
        init: function() {
            _.bindAll(this, '_handleCategoryClick');

            var self = this;

            self.ui = {
                nav: self.$el.find('nav')
            };

            self.ui.nav.find('button').hammer().on({
                tap: self._handleCategoryClick
            });
        },

        clearActive: function() {
            this.$el.find('.active').removeClass('active');
        },

        setActive: function(elem){
            this.clearActive();
            $(elem).closest('li').addClass('active');
        },

        getActive: function() {
            return this.ui.nav.find('.active button').text().toLowerCase().replace(/ /g, '-');
        },

        _handleCategoryClick: function(e){
            this.setActive(e.currentTarget);
            this.$el.trigger('change:active', this.getActive());
        }
    });
})(jQuery, window._);

/* **********************************************
     Begin ConversionWindow.js
********************************************** */

var ConversionWindow;

(function($, _){
    ConversionWindow = function(el) {
        this.el = el;
        this.$el = $(el);
        this.init();
    };

    _.extend(ConversionWindow.prototype, {
        init: function() {
            var self = this;

            self.ui = {
                from: self.$el.find('.convert-from'),
                to: self.$el.find('.convert-to')
            };
        },

        getFromValue: function (asNumber) {
            return (asNumber) ? Number(this.ui.from.find('.value').text()) : this.ui.from.find('.value').text();
        },

        setFromValue: function (val, silent) {
            this.ui.from.find('.value').text(val);
            if(!silent) { this.triggerChange(); }
        },

        triggerChange: function () {
            this.$el.trigger('change:fromValue', this.getFromValue());
        }
    });
})(jQuery, window._);

/* **********************************************
     Begin Calculator.js
********************************************** */

var Calculator;

(function($, _){
    Calculator = function(el) {
        this.el = el;
        this.$el = $(el);
        this.init();
    };

    _.extend(Calculator.prototype, {
        init: function() {
            _.bindAll(this, 'evaluate', '_handleDigitClick', '_handleFunctionClick', '_handleOperatorClick');

            var self = this;

            self.$el.find('.digit').hammer().on({
                tap: self._handleDigitClick
            });

            self.$el.find('.function').hammer().on({
                tap: self._handleFunctionClick
            });

            self.$el.find('.operator').hammer().on({
                tap: self._handleOperatorClick
            });

            self.$el.find('.evaluate').hammer().on({
                tap: self.evaluate
            });
        },

        evaluate: function () {
            this.$el.trigger('evaluate');
        },

        _handleDigitClick: function (e) {
            if ($(e.currentTarget).hasClass('decimal')) {
                this.$el.trigger('decimal');
            } else {
                this.$el.trigger('digit', Number($(e.currentTarget).text()));
            }
        },

        _handleFunctionClick: function (e) {
            var func = $(e.currentTarget).attr('data-func');

            switch (func) {
                case 'clear':
                    this.$el.trigger('clear');
                    break;

                case 'inverse':
                    this.$el.trigger('invert');
                    break;

                default:
                    console.log('No handler set for function: ' + func);
                    break;
            }
        },

        _handleOperatorClick: function (e) {
            this.$el.trigger($(e.currentTarget).attr('data-operation'));
        }
    });
})(jQuery, window._);

/* **********************************************
     Begin App.js
********************************************** */

var App;

(function($, _, CategoryMenu, ConversionWindow, Calculator){
    App = function(el) {
        this.el = el;
        this.$el = $(el);
    };

    _.extend(App.prototype, {
        init: function() {
            _.bindAll(this, '_handleToggleClick', '_handleSwipeLeft', '_handleSwipeRight', '_handleChangeActive', 'updateConversions', '_handleDigit', '_handleDecimal', '_handleClear', '_handleInvert', '_handleAdd', '_handleSubtract', '_handleDivide', '_handleMultiply', '_handleEvaluate');

            var self = this;

            self.ui = {
                toggle: self.$el.find('.toggle'),
                menu: self.$el.find('.unit-category'),
                conversions: self.$el.find('.conversions'),
                calc: self.$el.find('.calc'),
                stage: self.$el.find('.stage')
            };

            self.menu = this.getMenu();
            self.conversion = this.getConversion();
            self.calc = this.getCalc();

            self.silentClear = true;
            self.silentDigit = false;

            self.ui.toggle.hammer().on({
                tap: self._handleToggleClick
            });

            self.$el.hammer().on({
                dragleft: self._handleSwipeLeft,
                dragright: self._handleSwipeRight
            });

            self.menu.$el.bind({
                'change:active': self._handleChangeActive
            });

            self.conversion.$el.bind({
                'change:fromValue': self.updateConversions
            });

            self.calc.$el.bind({
                'digit': self._handleDigit,
                'decimal': self._handleDecimal,
                'clear': self._handleClear,
                'invert': self._handleInvert,
                'add': self._handleAdd,
                'subtract': self._handleSubtract,
                'divide': self._handleDivide,
                'multiply': self._handleMultiply,
                'evaluate': self._handleEvaluate
            });
        },

        getMenu: function () {
            return new CategoryMenu(this.ui.menu[0]);
        },

        getConversion: function () {
            return new ConversionWindow(this.ui.conversions[0]);
        },

        getCalc: function () {
            return new Calculator(this.ui.calc[0]);
        },

        getSilentClear: function () {
            return this.silentClear;
        },

        setSilentClear: function (val) {
            this.silentClear = val;
        },

        getSilentDigit: function () {
            return this.silentDigit;
        },

        setSilentDigit: function (val) {
            this.silentDigit = val;
        },

        toggleOpen: function(isOpen) {
            if(_.isUndefined(isOpen)) { isOpen = !this.isOpen(); }
            this.$el.toggleClass('menu-open', isOpen);
        },

        isOpen: function() {
            return this.$el.hasClass('menu-open');
        },

        updateConversions: function () {
            console.log('Update conversions based on: ' + this.conversion.getFromValue(true));
        },

        _operationPrep: function () {
            this.calc.evaluate();
            this.setSilentClear(true);
            this.setSilentDigit(true);
        },

        _handleToggleClick: function () {
            this.toggleOpen();
        },

        _handleSwipeLeft: function () {
            this.toggleOpen(false);
        },

        _handleSwipeRight: function () {
            this.toggleOpen(true);
        },

        _handleChangeActive: function (e, item) {
            this.toggleOpen(false);
            console.log('New active: ' + item);
        },

        _handleDigit: function (e, digit) {
            var val = (this.getSilentClear()) ? digit : this.conversion.getFromValue() + digit;
            this.conversion.setFromValue(val, this.getSilentDigit());
            this.setSilentClear(false);
        },

        _handleDecimal: function () {
            // Make sure there isn't already a decimal
            if (!_.contains(_.toArray(this.conversion.getFromValue()), '.') {
                this.conversion.setFromValue(this.conversion.getFromValue() + '.', this.getSilentDigit());
            } else if (_.contains(_.toArray(this.conversion.getFromValue()), '.') && this.getSilentClear()) {
                this.conversion.setFromValue('0.', this.getSilentDigit());
                this.setSilentClear(false);
            }
        },

        _handleClear: function () {
            this.calc.evaluate();
            this.conversion.setFromValue(0, this.getSilentDigit());
            this.setSilentClear(true);
            this.setSilentDigit(false);
        },

        _handleInvert: function () {
            this.conversion.setFromValue(this.conversion.getFromValue(true) * -1, this.getSilentDigit());
        },

        _handleAdd: function () {
            this._operationPrep();

            var self = this,
                mem = self.conversion.getFromValue(true);

            self.calc.$el.one('evaluate', function () {
                self.setSilentDigit(false);
                self.conversion.setFromValue(mem + self.conversion.getFromValue(true), self.getSilentDigit());
            });
        },

        _handleSubtract: function () {
            this._operationPrep();

            var self = this,
                mem = self.conversion.getFromValue(true);

            self.calc.$el.one('evaluate', function () {
                self.setSilentDigit(false);
                self.conversion.setFromValue(mem - self.conversion.getFromValue(true), self.getSilentDigit());
            });
        },

        _handleDivide: function () {
            this._operationPrep();

            var self = this,
                mem = self.conversion.getFromValue(true);

            mem = self.conversion.getFromValue(true);

            self.calc.$el.one('evaluate', function () {
                self.setSilentDigit(false);
                self.conversion.setFromValue(mem / self.conversion.getFromValue(true), self.getSilentDigit());
            });
        },

        _handleMultiply: function () {
            this._operationPrep();

            var self = this,
                mem = self.conversion.getFromValue(true);

            self.calc.$el.one('evaluate', function () {
                self.setSilentDigit(false);
                self.conversion.setFromValue(mem * self.conversion.getFromValue(true), self.getSilentDigit());
            });
        },

        _handleEvaluate: function () {
            this.setSilentClear(true);
            this.setSilentDigit(false);
        }
    });
})(jQuery, window._, window.CategoryMenu, window.ConversionWindow, window.Calculator);

/* **********************************************
     Begin application.js
********************************************** */

// @codekit-prepend 'Helpers.js';
// @codekit-prepend 'models/CategoryMenu.js';
// @codekit-prepend 'models/ConversionWindow.js';
// @codekit-prepend 'models/Calculator.js';
// @codekit-prepend 'models/App.js';

var app;

(function($){
    var UA = navigator.userAgent,
        ios = (UA.match(/(iPad|iPhone|iPod)/g)) ? true : false,
        msafari = (UA.match(/Safari/i) && !UA.match(/Chrome/i) && !UA.match(/CriOS/i)) ? true : false;

    $(document).ready(function() {
        if (!window.navigator.standalone && ios) {
            if(!msafari) { $('#install .message').html('You must be using Safari to install <strong>thistothat</strong>'); }
        } else {
            $('#install').remove();
        }

        $('#install').remove();

        app = new App($('body')[0]);
        app.init();
    });
})(jQuery);